{"files":[{"id":"6f0ad147-d324-4b12-a00f-c91d4afff251","name":"appsscript","type":"json","source":"{\n  \"timeZone\": \"Asia/Bangkok\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}"},{"id":"8ae4a026-031e-408f-a6db-058d80586aac","name":"‡∏£‡∏´‡∏±‡∏™","type":"server_js","source":"var CHANNEL_TOKEN \u003d \"qEK24lgsKG55/v5k6s/gCzkA1b83w7tuItLyTxAlE7j5UYUWnDpJqVYEuc1bfSxbscYCGypoqweigDaylUAobmPrzsqDJGph2WfykM5pKPahU3seIajXe/xj/iqLSPTrfrVarWVGhxNpssS+D6ayqgdB04t89/1O/w1cDnyilFU\u003d\";\nvar GDRIVE_FOLDER_ID \u003d \"1TLqoTZojBTPgt62Pbl5s-B1PStr2P-Mf\";\nvar GDRIVE_FOLDER_IMAGE_ID \u003d \"1fP6ECq6QILUbkvk728tg_rrrdMkc9GKp\";\nvar GDRIVE_FOLDER_VIDEO_ID \u003d \"1JH0zyup0sRkLuob7nwqguaOqaNks9ta2\";\nvar GDRIVE_FOLDER_AUDIO_ID \u003d \"1KHu6LwcdYhMGLT4vxLjADJY6jVBBSJj4\";\nvar GDRIVE_FOLDER_DOCUMENT_ID \u003d\"1KAkuG3t45qpAVFTtM6tjlHdk15-9ia0e\"; // ‡πÉ‡∏™‡πà ID ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£\n\nfunction replyMsg(replyToken, messages) {\n  var url \u003d \u0027https://api.line.me/v2/bot/message/reply\u0027;\n  var options \u003d {\n    \u0027headers\u0027: {\n      \u0027Content-Type\u0027: \u0027application/json; charset\u003dUTF-8\u0027,\n      \u0027Authorization\u0027: \u0027Bearer \u0027 + CHANNEL_TOKEN\n    },\n    \u0027method\u0027: \u0027post\u0027,\n    \u0027payload\u0027: JSON.stringify({\n      \u0027replyToken\u0027: replyToken,\n      \u0027messages\u0027: messages\n    })\n  };\n  UrlFetchApp.fetch(url, options);\n}\n\nfunction getOrCreateFolder(parentFolderId, groupId) {\n  var parent \u003d DriveApp.getFolderById(parentFolderId);\n  var folders \u003d parent.getFoldersByName(groupId);\n  return folders.hasNext() ? folders.next() : parent.createFolder(groupId);\n}\n\nfunction toDrive(messageId, mimeType, ext, parentFolderId, groupId) {\n  var url \u003d \"https://api-data.line.me/v2/bot/message/\" + messageId + \"/content\";\n  var headers \u003d {\n    \"headers\": { \"Authorization\": \"Bearer \" + CHANNEL_TOKEN }\n  };\n  try {\n    var content \u003d UrlFetchApp.fetch(url, headers);\n    var blob \u003d content.getBlob();\n    var fileBlob \u003d Utilities.newBlob(blob.getBytes(), mimeType, messageId + ext);\n    var folder \u003d getOrCreateFolder(parentFolderId, groupId);\n    var fileId \u003d folder.createFile(fileBlob).getId();\n    return \u0027https://drive.google.com/file/d/\u0027 + fileId + \u0027/view\u0027;\n  } catch (e) {\n    Logger.log(\"Error uploading to Google Drive: \" + e);\n    return null;\n  }\n}\n\nfunction handleFileMessage(event) {\n  var fileName \u003d event.message.fileName;\n  var fileType \u003d fileName.split(\u0027.\u0027).pop();\n  var mimetype \u003d getMimeType(fileType);\n  var groupId \u003d (event.source \u0026\u0026 event.source.groupId) ? event.source.groupId : \"individual\";\n\n  if (mimetype !\u003d\u003d \"undefined\") {\n    var messageId \u003d event.message.id;\n    var url \u003d \"https://api-data.line.me/v2/bot/message/\" + messageId + \"/content\";\n    var headers \u003d {\n      \"headers\": { \"Authorization\": \"Bearer \" + CHANNEL_TOKEN }\n    };\n\n    try {\n      var content \u003d UrlFetchApp.fetch(url, headers);\n      var blob \u003d content.getBlob();\n      var fileBlob \u003d Utilities.newBlob(blob.getBytes(), mimetype, fileName);\n      var folder \u003d getOrCreateFolder(GDRIVE_FOLDER_ID, groupId);\n      var fileId \u003d folder.createFile(fileBlob).getId();\n      return [{\n        \u0027type\u0027: \u0027text\u0027,\n        \u0027text\u0027: \u0027üìÅ ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå: \u0027 + fileName +\n                \u0027\\n‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°: \u0027 + groupId +\n                \u0027\\n‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Google Drive:\\nhttps://drive.google.com/file/d/\u0027 + fileId + \u0027/view\u0027\n      }];\n    } catch (e) {\n      Logger.log(\"Error uploading to Google Drive: \" + e);\n      return [{ \u0027type\u0027: \u0027text\u0027, \u0027text\u0027: \u0027‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏ì‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î\u0027 }];\n    }\n  } else {\n    return [{ \u0027type\u0027: \u0027text\u0027, \u0027text\u0027: \u0027‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ô‡∏µ‡πâ\u0027 }];\n  }\n}\n\nfunction getMimeType(fileType) {\n  var mimeTypes \u003d {\n    \"pdf\": \"application/pdf\",\n    \"zip\": \"application/zip\",\n    \"rar\": \"application/vnd.rar\",\n    \"7z\": \"application/x-7z-compressed\",\n    \"doc\": \"application/msword\",\n    \"xls\": \"application/vnd.ms-excel\",\n    \"ppt\": \"application/vnd.ms-powerpoint\",\n    \"docx\": \"application/vnd.openxmlformats-officedocument.wordprocessingml.document\",\n    \"xlsx\": \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\",\n    \"pptx\": \"application/vnd.openxmlformats-officedocument.presentationml.presentation\",\n    \"txt\": \"text/plain\",\n    \"csv\": \"text/csv\",\n    \"json\": \"application/json\",\n    \"xml\": \"application/xml\",\n    \"html\": \"text/html\",\n    \"mp4\": \"video/mp4\",\n    \"mp3\": \"audio/mpeg\",\n    \"png\": \"image/png\",\n    \"gif\": \"image/gif\",\n    \"jpg\": \"image/jpeg\",\n    \"jpeg\": \"image/jpeg\"\n  };\n  return mimeTypes[fileType] || \"application/octet-stream\"; // fallback for unknown\n}\n\nfunction doPost(e) {\n  var value \u003d JSON.parse(e.postData.contents);\n  var event \u003d value.events[0];\n  var type \u003d event.type;\n  var replyToken \u003d event.replyToken;\n  var groupId \u003d (event.source \u0026\u0026 event.source.groupId) ? event.source.groupId : \"individual\";\n\n  if (messageType \u003d\u003d\u003d \u0027file\u0027) {\n  var fileType \u003d event.message.fileName.split(\u0027.\u0027).pop().toLowerCase();\n  var imageTypes \u003d [\"jpg\", \"jpeg\", \"png\", \"gif\"];\n  var videoTypes \u003d [\"mp4\"];\n  var audioTypes \u003d [\"mp3\"];\n\n  if (imageTypes.includes(fileType)) {\n    replyMessage \u003d [{\n      \u0027type\u0027: \u0027text\u0027,\n      \u0027text\u0027: \u0027üñºÔ∏è ‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û\\n‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà:\\n\u0027 +\n        toDrive(event.message.id, \"image/jpeg\", \".jpg\", GDRIVE_FOLDER_IMAGE_ID, groupId)\n    }];\n  } else if (videoTypes.includes(fileType)) {\n    replyMessage \u003d [{\n      \u0027type\u0027: \u0027text\u0027,\n      \u0027text\u0027: \u0027üéûÔ∏è ‡πÑ‡∏ü‡∏•‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠\\n‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà:\\n\u0027 +\n        toDrive(event.message.id, \"video/mp4\", \".mp4\", GDRIVE_FOLDER_VIDEO_ID, groupId)\n    }];\n  } else if (audioTypes.includes(fileType)) {\n    replyMessage \u003d [{\n      \u0027type\u0027: \u0027text\u0027,\n      \u0027text\u0027: \u0027üîä ‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á\\n‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà:\\n\u0027 +\n        toDrive(event.message.id, \"audio/mpeg\", \".mp3\", GDRIVE_FOLDER_AUDIO_ID, groupId)\n    }];\n  } else {\n    replyMessage \u003d [{\n      \u0027type\u0027: \u0027text\u0027,\n      \u0027text\u0027: \u0027üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ\\n‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏µ‡πà:\\n\u0027 +\n        toDrive(event.message.id, getMimeType(fileType), \".\" + fileType, GDRIVE_FOLDER_DOCUMENT_ID, groupId)\n    }];\n  }\n}\n}\n"}]}